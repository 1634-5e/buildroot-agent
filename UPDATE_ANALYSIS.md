# Buildroot Agent è‡ªæ›´æ–°åŠŸèƒ½åˆ†ææŠ¥å‘Š

## ğŸ“‹ æ ¸å¿ƒå‡½æ•°åˆ†æ

### 1. æ›´æ–°æ£€æŸ¥å‡½æ•°
**å‡½æ•°**: `update_check_version(agent_context_t *ctx)`  
**ä½ç½®**: `src/agent_update.c:97-136`  
**åŠŸèƒ½**: å‘æœåŠ¡å™¨å‘é€ç‰ˆæœ¬æ£€æŸ¥è¯·æ±‚  
**æµ‹è¯•ç‚¹**:
- æ¶ˆæ¯æ ¼å¼æ­£ç¡®æ€§ (JSONç»“æ„)
- è®¾å¤‡IDå’Œç‰ˆæœ¬ä¿¡æ¯ä¼ é€’
- é”™è¯¯å¤„ç† (å†…å­˜åˆ†é…ã€ç½‘ç»œè¿æ¥)

### 2. æ›´æ–°ä¸‹è½½å‡½æ•°  
**å‡½æ•°**: `update_download_package(const char *url, const char *output_path, progress_callback_t callback, void *user_data)`  
**ä½ç½®**: `src/agent_update.c:139-160`  
**åŠŸèƒ½**: é€šè¿‡TCPä¸‹è½½æ›´æ–°åŒ…  
**æµ‹è¯•ç‚¹**:
- TCPä¸‹è½½é…ç½®å‚æ•°éªŒè¯
- è¿›åº¦å›è°ƒæœºåˆ¶
- æ–­ç‚¹ç»­ä¼ æ”¯æŒ
- ä¸‹è½½é”™è¯¯å¤„ç†

### 3. åŒ…éªŒè¯å‡½æ•°
**å‡½æ•°**: `update_verify_package(const char *filepath, const char *expected_md5, const char *expected_sha256)`  
**ä½ç½®**: `src/agent_update.c:163-237`  
**åŠŸèƒ½**: éªŒè¯ä¸‹è½½æ–‡ä»¶çš„å®Œæ•´æ€§  
**æµ‹è¯•ç‚¹**:
- æ–‡ä»¶å¤§å°åŒ¹é…
- MD5/SHA256æ ¡éªŒå’ŒéªŒè¯
- é”™è¯¯çŠ¶æ€æ›´æ–°

### 4. å¤‡ä»½å‡½æ•°
**å‡½æ•°**: `update_backup_current_version(const char *backup_dir, char *backup_path)`  
**ä½ç½®**: `src/agent_update.c:240-297`  
**åŠŸèƒ½**: å¤‡ä»½å½“å‰ç‰ˆæœ¬  
**æµ‹è¯•ç‚¹**:
- äºŒè¿›åˆ¶è·¯å¾„è·å– (`/proc/self/exe`)
- å¤‡ä»½ç›®å½•åˆ›å»º
- æ–‡ä»¶æƒé™è®¾ç½®
- å¤‡ä»½æ–‡ä»¶å‘½åæ ¼å¼

### 5. å®‰è£…å‡½æ•°
**å‡½æ•°**: `update_install_package(const char *package_path)`  
**ä½ç½®**: `src/agent_update.c:459-523`  
**åŠŸèƒ½**: è§£å‹å¹¶å®‰è£…æ›´æ–°åŒ…  
**æµ‹è¯•ç‚¹**:
- taråŒ…è§£å‹
- æ–°äºŒè¿›åˆ¶æ–‡ä»¶æŸ¥æ‰¾
- åŸå­æ›¿æ¢æœºåˆ¶
- å®‰è£…éªŒè¯

### 6. åŸå­å®‰è£…å‡½æ•°
**å‡½æ•°**: `install_new_binary(const char *new_binary_path)` (é™æ€)  
**ä½ç½®**: `src/agent_update.c:342-429`  
**åŠŸèƒ½**: åŸå­æ€§æ›¿æ¢äºŒè¿›åˆ¶æ–‡ä»¶  
**æµ‹è¯•ç‚¹**:
- ä¸´æ—¶æ–‡ä»¶æ“ä½œ
- åŸå­renameæ“ä½œ
- æƒé™è®¾ç½®
- å¤±è´¥å›æ»š

### 7. é‡å¯å‡½æ•°
**å‡½æ•°**: `update_restart_agent(void)`  
**ä½ç½®**: `src/agent_update.c:526-586`  
**åŠŸèƒ½**: é‡å¯Agentè¿›ç¨‹  
**æµ‹è¯•ç‚¹**:
- è¿›ç¨‹fork/execæ“ä½œ
- PIDæ–‡ä»¶å¤„ç†
- å­è¿›ç¨‹å¯åŠ¨éªŒè¯

### 8. å›æ»šå‡½æ•°
**å‡½æ•°**: `update_rollback_to_backup(const char *backup_path)`  
**ä½ç½®**: `src/agent_update.c:589-683`  
**åŠŸèƒ½**: å›æ»šåˆ°å¤‡ä»½ç‰ˆæœ¬  
**æµ‹è¯•ç‚¹**:
- å¤‡ä»½æ–‡ä»¶éªŒè¯
- æ–‡ä»¶æ›¿æ¢æ“ä½œ
- è¿›ç¨‹é‡å¯

## ğŸ”„ åè®®æ¶ˆæ¯åˆ†æ

### æ¶ˆæ¯ç±»å‹å®šä¹‰
**ä½ç½®**: `include/agent.h:71-80`

| æ¶ˆæ¯ç±»å‹ | å€¼ | æ–¹å‘ | æè¿° |
|---------|----|----|----- |
| MSG_TYPE_UPDATE_CHECK | 0x60 | Agentâ†’Server | æ£€æŸ¥æ›´æ–°è¯·æ±‚ |
| MSG_TYPE_UPDATE_INFO | 0x61 | Serverâ†’Agent | æ›´æ–°ä¿¡æ¯å“åº” |
| MSG_TYPE_UPDATE_DOWNLOAD | 0x62 | Agentâ†’Server | è¯·æ±‚ä¸‹è½½æ›´æ–°åŒ… |
| MSG_TYPE_UPDATE_PROGRESS | 0x63 | Agentâ†’Server | ä¸ŠæŠ¥ä¸‹è½½è¿›åº¦ |
| MSG_TYPE_UPDATE_APPROVE | 0x64 | Serverâ†’Agent | æœåŠ¡å™¨æ‰¹å‡†ä¸‹è½½ |
| MSG_TYPE_UPDATE_COMPLETE | 0x65 | Agentâ†’Server | æ›´æ–°å®Œæˆé€šçŸ¥ |
| MSG_TYPE_UPDATE_ERROR | 0x66 | Agent/Serverâ†’Server/Agent | æ›´æ–°é”™è¯¯é€šçŸ¥ |
| MSG_TYPE_UPDATE_ROLLBACK | 0x67 | Agent/Serverâ†’Server/Agent | å›æ»šé€šçŸ¥ |

## âš™ï¸ é…ç½®å‚æ•°åˆ†æ

### æ›´æ–°ç›¸å…³é…ç½®
**ä½ç½®**: `agent.conf:37-66`

| å‚æ•° | é»˜è®¤å€¼ | æè¿° | æµ‹è¯•å½±å“ |
|-----|------|------|---------|
| enable_auto_update | false | æ˜¯å¦å¯ç”¨è‡ªåŠ¨æ›´æ–° | æ§åˆ¶æ›´æ–°æ£€æŸ¥è§¦å‘ |
| update_check_interval | 86400 | æ£€æŸ¥é—´éš”(ç§’) | å½±å“æµ‹è¯•é¢‘ç‡ |
| update_channel | "stable" | æ›´æ–°æ¸ é“ | ç‰ˆæœ¬é€‰æ‹©é€»è¾‘ |
| update_require_confirm | true | æ˜¯å¦éœ€è¦ç¡®è®¤ | è‡ªåŠ¨/æ‰‹åŠ¨æ›´æ–° |
| update_temp_path | "/var/lib/agent/temp" | ä¸´æ—¶è·¯å¾„ | ç£ç›˜ç©ºé—´æµ‹è¯• |
| update_backup_path | "/var/lib/agent/backup" | å¤‡ä»½è·¯å¾„ | å›æ»šåŠŸèƒ½æµ‹è¯• |
| update_rollback_on_fail | true | å¤±è´¥è‡ªåŠ¨å›æ»š | é”™è¯¯æ¢å¤æµ‹è¯• |
| update_rollback_timeout | 300 | å›æ»šè¶…æ—¶(ç§’) | è¶…æ—¶å¤„ç†æµ‹è¯• |
| update_verify_checksum | true | æ ¡éªŒæ–‡ä»¶æ ¡éªŒå’Œ | å®‰å…¨æ€§æµ‹è¯• |

## ğŸš¨ æ½œåœ¨é£é™©ç‚¹

### 1. ç£ç›˜ç©ºé—´ä¸è¶³
- **ä½ç½®**: `update_backup_current_version()`, `update_download_package()`
- **é£é™©**: ä¸‹è½½æˆ–å¤‡ä»½æ—¶ç©ºé—´ä¸è¶³
- **æµ‹è¯•**: æ¨¡æ‹Ÿç£ç›˜æ»¡åœºæ™¯

### 2. æƒé™é—®é¢˜
- **ä½ç½®**: `install_new_binary()`, `update_rollback_to_backup()`
- **é£é™©**: æ— æ³•å†™å…¥ç³»ç»Ÿç›®å½•
- **æµ‹è¯•**: ä¸åŒæƒé™çº§åˆ«æµ‹è¯•

### 3. ç½‘ç»œä¸­æ–­
- **ä½ç½®**: `update_download_package()`
- **é£é™©**: ä¸‹è½½è¿‡ç¨‹ä¸­æ–­
- **æµ‹è¯•**: ç½‘ç»œå¼‚å¸¸æ¨¡æ‹Ÿ

### 4. æ–‡ä»¶æŸå
- **ä½ç½®**: `update_verify_package()`
- **é£é™©**: æ ¡éªŒå’Œä¸åŒ¹é…
- **æµ‹è¯•**: æŸååŒ…æµ‹è¯•

### 5. è¿›ç¨‹å¯åŠ¨å¤±è´¥
- **ä½ç½®**: `update_restart_agent()`
- **é£é™©**: æ–°ç‰ˆæœ¬æ— æ³•å¯åŠ¨
- **æµ‹è¯•**: å¯æ‰§è¡Œæ–‡ä»¶æŸåæµ‹è¯•

## ğŸ§ª æµ‹è¯•åœºæ™¯å»ºè®®

### åŸºç¡€åŠŸèƒ½æµ‹è¯•
1. æ­£å¸¸æ›´æ–°æµç¨‹æµ‹è¯•
2. ç‰ˆæœ¬å›é€€æµ‹è¯•  
3. é‡å¤æ›´æ–°æµ‹è¯•
4. å¼ºåˆ¶æ›´æ–°æµ‹è¯•

### å¼‚å¸¸æƒ…å†µæµ‹è¯•
1. ç½‘ç»œä¸­æ–­æ¢å¤æµ‹è¯•
2. ç£ç›˜ç©ºé—´ä¸è¶³æµ‹è¯•
3. æƒé™ä¸è¶³æµ‹è¯•
4. æŸååŒ…æ£€æµ‹æµ‹è¯•
5. è¿›ç¨‹å¯åŠ¨å¤±è´¥æµ‹è¯•

### è¾¹ç•Œæ¡ä»¶æµ‹è¯•
1. è¶…å¤§æ›´æ–°åŒ…æµ‹è¯•
2. ç©ºæ›´æ–°åŒ…æµ‹è¯•
3. ç‰¹æ®Šå­—ç¬¦è·¯å¾„æµ‹è¯•
4. å¹¶å‘æ›´æ–°è¯·æ±‚æµ‹è¯•

## ğŸ“Š å…³é”®æŒ‡æ ‡

### æ€§èƒ½æŒ‡æ ‡
- ä¸‹è½½é€Ÿåº¦
- å®‰è£…æ—¶é—´
- å¯åŠ¨æ—¶é—´
- å†…å­˜ä½¿ç”¨

### å¯é æ€§æŒ‡æ ‡
- æ›´æ–°æˆåŠŸç‡
- å›æ»šæˆåŠŸç‡
- é”™è¯¯æ¢å¤æ—¶é—´
- ç³»ç»Ÿç¨³å®šæ€§

### å®‰å…¨æ€§æŒ‡æ ‡
- æ ¡éªŒå’ŒéªŒè¯
- æƒé™æ§åˆ¶
- åŸå­æ“ä½œä¿è¯
- å¤‡ä»½å®Œæ•´æ€§