<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buildroot Agent æ§åˆ¶å°</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0d0d12;
            --bg-secondary: #16161e;
            --bg-tertiary: #1e1e28;
            --bg-elevated: #252532;
            
            --text-primary: #f0f0f5;
            --text-secondary: #a0a0b0;
            --text-muted: #6e6e80;
            
            --accent-primary: #6366f1;
            --accent-secondary: #8b5cf6;
            --accent-success: #10b981;
            --accent-warning: #f59e0b;
            --accent-error: #ef4444;
            
            --border-color: rgba(255, 255, 255, 0.08);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.4);
            
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 14px;
            
            --transition: 200ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        .app {
            display: grid;
            grid-template-columns: 64px 320px 1fr;
            height: 100vh;
        }

        @media (max-width: 1024px) {
            .app { grid-template-columns: 64px 1fr; }
            .sidebar-secondary { display: none; }
        }

        @media (max-width: 640px) {
            .app { grid-template-columns: 1fr; }
            .sidebar-primary { display: none; }
        }

        /* Primary Sidebar */
        .sidebar-primary {
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 16px 0;
            gap: 8px;
        }

        .nav-logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-bottom: 16px;
            box-shadow: 0 4px 16px rgba(99, 102, 241, 0.4);
        }

        .nav-item {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            font-size: 22px;
            cursor: pointer;
            transition: all var(--transition);
            position: relative;
        }

        .nav-item:hover, .nav-item.active {
            background: rgba(99, 102, 241, 0.15);
            color: var(--accent-primary);
        }

        .nav-item.active::before {
            content: '';
            position: absolute;
            left: -16px;
            top: 50%;
            transform: translateY(-50%);
            width: 3px;
            height: 24px;
            background: var(--accent-primary);
            border-radius: 0 3px 3px 0;
        }

        .nav-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 8px;
            height: 8px;
            background: var(--accent-error);
            border-radius: 50%;
            border: 2px solid var(--bg-secondary);
        }

        /* Secondary Sidebar */
        .sidebar-secondary {
            background: var(--bg-tertiary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .connection-status {
            font-size: 13px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .connection-status.online {
            color: var(--accent-success);
        }

        .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
        }

        .connection-status.online .connection-dot {
            background: var(--accent-success);
            box-shadow: 0 0 8px var(--accent-success);
        }

        .device-search {
            margin: 12px 20px;
        }

        .device-search input {
            width: 100%;
            padding: 10px 14px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
        }

        .device-search input:focus {
            border-color: var(--accent-primary);
        }

        .device-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .device-card {
            padding: 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            margin-bottom: 8px;
            cursor: pointer;
            transition: all var(--transition);
        }

        .device-card:hover {
            border-color: rgba(99, 102, 241, 0.3);
            transform: translateX(4px);
        }

        .device-card.active {
            background: rgba(99, 102, 241, 0.1);
            border-color: var(--accent-primary);
        }

        .device-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .device-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .device-info h4 {
            font-size: 14px;
            font-weight: 600;
        }

        .device-status {
            font-size: 12px;
            color: var(--accent-success);
        }

        .device-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
        }

        .device-metric {
            text-align: center;
        }

        .device-metric-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--accent-primary);
        }

        .device-metric-label {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* Main Content */
        .main {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            text-align: center;
        }

        .empty-icon {
            font-size: 80px;
            margin-bottom: 24px;
            opacity: 0.3;
        }

        .empty-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .empty-text {
            font-size: 15px;
            color: var(--text-secondary);
        }

        /* Device Detail */
        .device-detail {
            display: none;
            flex-direction: column;
            height: 100%;
        }

        .device-detail.active {
            display: flex;
        }

        .detail-header {
            padding: 20px 24px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .detail-title {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .detail-title h2 {
            font-size: 20px;
            font-weight: 600;
        }

        .connection-pill {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(16, 185, 129, 0.15);
            color: var(--accent-success);
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .detail-actions {
            display: flex;
            gap: 12px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            padding: 0 24px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .tab {
            padding: 12px 20px;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab:hover {
            color: var(--text-primary);
        }

        .tab.active {
            color: var(--accent-primary);
            border-bottom-color: var(--accent-primary);
        }

        /* Tab Content */
        .tab-content {
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        .tab-pane {
            position: absolute;
            inset: 0;
            overflow-y: auto;
            padding: 24px;
            display: none;
        }

        .tab-pane.active {
            display: block;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Terminal */
        .terminal-container {
            height: 100%;
            display: flex;
            flex-direction: column;
            background: var(--bg-tertiary);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .terminal-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .terminal-info {
            display: flex;
            align-items: center;
            gap: 12px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
        }

        .terminal-shell {
            color: var(--text-muted);
        }

        .terminal-path {
            color: var(--accent-primary);
            cursor: pointer;
        }

        .terminal-controls {
            display: flex;
            gap: 8px;
        }

        .terminal-btn {
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: all var(--transition);
        }

        .terminal-btn:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .terminal-output {
            flex: 1;
            padding: 16px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            line-height: 1.6;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
            background: var(--bg-primary);
        }

        .terminal-input-line {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
        }

        .terminal-prompt {
            color: var(--accent-success);
            font-weight: 600;
            white-space: nowrap;
            font-family: 'JetBrains Mono', monospace;
        }

        .terminal-input {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
        }

        /* Files - VSCode Style (Two Column) */
        .files-layout {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 0;
            height: 100%;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }
        
        @media (max-width: 1024px) {
            .files-layout {
                grid-template-columns: 260px 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .files-layout {
                grid-template-columns: 1fr;
            }
            .file-sidebar {
                display: none;
            }
        }

        .file-sidebar {
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .file-sidebar-header {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .file-sidebar-actions {
            display: flex;
            gap: 4px;
        }

        .file-sidebar-actions .btn-icon {
            width: 28px;
            height: 28px;
            padding: 0;
            font-size: 14px;
            background: transparent;
            border: none;
            color: var(--text-muted);
        }

        .file-sidebar-actions .btn-icon:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .file-selection-info {
            padding: 8px 12px;
            border-top: 1px solid var(--border-color);
            font-size: 12px;
            color: var(--text-muted);
            background: var(--bg-tertiary);
        }

        .file-tree {
            flex: 1;
            overflow-y: auto;
            padding: 4px 0;
            font-size: 13px;
        }

        .file-tree-root {
            padding-left: 0;
        }

        .tree-item {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px 3px 4px;
            cursor: pointer;
            transition: all var(--transition);
            user-select: none;
            margin: 1px 4px;
            border-radius: var(--radius-sm);
        }

        .tree-item:hover {
            background: var(--bg-tertiary);
        }

        .tree-item.selected {
            background: rgba(99, 102, 241, 0.25);
        }

        .tree-item.focused {
            outline: 1px solid var(--accent-primary);
            outline-offset: -1px;
        }

        .tree-item.expanded > .tree-toggle {
            transform: rotate(90deg);
        }

        .tree-toggle {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: var(--text-muted);
            transition: transform var(--transition);
            flex-shrink: 0;
        }

        .tree-toggle.empty {
            visibility: hidden;
        }

        .tree-icon {
            width: 16px;
            text-align: center;
            font-size: 14px;
            flex-shrink: 0;
        }

        .tree-label {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .tree-children {
            padding-left: 16px;
            display: none;
        }

        .tree-item.expanded + .tree-children {
            display: block;
        }

        .tree-loading {
            padding: 4px 8px 4px 36px;
            color: var(--text-muted);
            font-size: 12px;
        }

        /* File Preview Panel */
        .file-preview-panel {
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .file-preview-placeholder {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
        }
        .file-preview {
            background: var(--bg-tertiary);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .file-preview-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }

        .file-preview-title {
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 0;
        }

        .file-preview-title span:first-child {
            font-weight: 600;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .file-preview-size {
            font-size: 12px;
            color: var(--text-muted);
            white-space: nowrap;
        }

        .file-preview-actions {
            display: flex;
            gap: 8px;
        }

        .file-preview-content {
            flex: 1;
            overflow: auto;
            padding: 16px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-all;
            background: var(--bg-primary);
        }

        .file-preview-content.image {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .file-preview-content.image img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .file-preview-content.binary {
            color: var(--text-muted);
            font-style: italic;
        }

        .file-browser-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            gap: 16px;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 13px;
        }

        .breadcrumb-item {
            padding: 4px 8px;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: all var(--transition);
        }

        .breadcrumb-item:hover {
            color: var(--text-primary);
            background: var(--bg-tertiary);
        }

        .file-browser-actions {
            display: flex;
            gap: 8px;
        }

        .file-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 16px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all var(--transition);
        }

        .file-item:hover {
            background: var(--bg-tertiary);
        }

        .file-icon {
            font-size: 20px;
            width: 32px;
            text-align: center;
        }

        .file-details {
            flex: 1;
        }

        .file-name {
            font-size: 14px;
            margin-bottom: 2px;
        }

        .file-meta {
            font-size: 12px;
            color: var(--text-muted);
        }

        .file-size {
            font-size: 13px;
            color: var(--text-secondary);
            width: 80px;
            text-align: right;
        }

        /* Monitor - Enhanced */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .metric-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 20px;
        }

        .metric-card.large {
            grid-column: span 2;
        }

        .metric-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .metric-title {
            font-size: 14px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .metric-value {
            font-size: 32px;
            font-weight: 700;
        }

        .metric-subtitle {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .metric-bar {
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 12px;
        }

        .metric-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .metric-bar-fill.low { background: var(--accent-success); }
        .metric-bar-fill.medium { background: var(--accent-warning); }
        .metric-bar-fill.high { background: var(--accent-error); }

        .metric-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }

        .metric-detail {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
        }

        .metric-detail-label {
            color: var(--text-muted);
        }

        .metric-detail-value {
            color: var(--text-primary);
            font-weight: 500;
        }

        /* Process Table */
        .process-table {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .process-table-header {
            display: grid;
            grid-template-columns: 60px 1fr 100px 100px 80px;
            gap: 12px;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .process-row {
            display: grid;
            grid-template-columns: 60px 1fr 100px 100px 80px;
            gap: 12px;
            padding: 10px 16px;
            border-bottom: 1px solid var(--border-color);
            font-size: 13px;
            transition: background var(--transition);
        }

        .process-row:hover {
            background: var(--bg-tertiary);
        }

        .process-pid {
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }

        .process-name {
            color: var(--text-primary);
            font-weight: 500;
        }

        .process-cpu, .process-mem {
            color: var(--accent-primary);
        }

        /* Scripts */
        textarea.script-editor {
            width: 100%;
            padding: 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            min-height: 300px;
            resize: vertical;
            outline: none;
        }

        textarea.script-editor:focus {
            border-color: var(--accent-primary);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 24px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 16px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-sm);
            transition: all var(--transition);
        }

        .modal-close:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 24px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        pre.output {
            background: var(--bg-primary);
            padding: 16px;
            border-radius: var(--radius-md);
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 20px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition);
        }

        .btn:hover {
            background: var(--bg-elevated);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .btn-primary {
            background: var(--accent-primary);
            border-color: transparent;
            color: white;
        }

        .btn-primary:hover {
            background: #5558e6;
            box-shadow: 0 4px 16px rgba(99, 102, 241, 0.4);
        }

        .btn-danger {
            background: var(--accent-error);
            border-color: transparent;
            color: white;
        }

        .btn-sm {
            padding: 6px 14px;
            font-size: 13px;
        }

        /* Toast */
        .toast-container {
            position: fixed;
            top: 24px;
            right: 24px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .toast {
            padding: 16px 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            animation: toastIn 0.3s ease;
        }

        @keyframes toastIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .toast.success { border-left: 3px solid var(--accent-success); }
        .toast.error { border-left: 3px solid var(--accent-error); }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .empty-folder {
            padding: 60px 20px;
            text-align: center;
            color: var(--text-muted);
        }

        .empty-folder-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="toast-container" id="toastContainer"></div>

    <div class="app">
        <!-- Primary Sidebar -->
        <nav class="sidebar-primary">
            <div class="nav-logo">ğŸ–¥ï¸</div>
            <div class="nav-item active" data-view="devices" onclick="showView('devices')" title="è®¾å¤‡">
                ğŸ“±
            </div>
            <div class="nav-item" title="è®¾ç½®" onclick="showSettings()">
                âš™ï¸
            </div>
        </nav>

        <!-- Secondary Sidebar -->
        <aside class="sidebar-secondary" id="deviceSidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">è®¾å¤‡åˆ—è¡¨</div>
                <div class="connection-status" id="connectionStatusText">
                    <span class="connection-dot"></span>
                    <span>æœªè¿æ¥</span>
                </div>
            </div>
            <div class="device-search">
                <input type="text" placeholder="æœç´¢è®¾å¤‡..." id="deviceSearch" oninput="filterDevices()">
            </div>
            <div class="device-list" id="deviceList">
                <div style="padding: 40px; text-align: center; color: var(--text-muted);">
                    <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“¡</div>
                    <div>ç­‰å¾…è®¾å¤‡è¿æ¥...</div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main">
            <!-- Empty State -->
            <div class="empty-state" id="emptyState">
                <div class="empty-icon">ğŸ“±</div>
                <div class="empty-title">é€‰æ‹©è®¾å¤‡å¼€å§‹</div>
                <div class="empty-text">ä»å·¦ä¾§è®¾å¤‡åˆ—è¡¨é€‰æ‹©ä¸€ä¸ªè®¾å¤‡ä»¥å¼€å§‹ç®¡ç†å’Œç›‘æ§</div>
            </div>

            <!-- Device Detail View -->
            <div class="device-detail" id="deviceDetail">
                <!-- Header -->
                <div class="detail-header">
                    <div class="detail-title">
                        <div style="font-size: 32px;">ğŸ“±</div>
                        <div>
                            <h2 id="detailDeviceName">--</h2>
                            <div style="display: flex; gap: 8px; margin-top: 4px;">
                                <span class="connection-pill">
                                    <span>â—</span>
                                    <span>åœ¨çº¿</span>
                                </span>
                                <span style="font-size: 13px; color: var(--text-muted);" id="detailDeviceIp">--</span>
                            </div>
                        </div>
                    </div>
                    <div class="detail-actions">
                        <button class="btn btn-sm" onclick="disconnectDevice()">æ–­å¼€</button>
                        <button class="btn btn-danger btn-sm" onclick="rebootDevice()">é‡å¯</button>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="tabs">
                    <div class="tab active" data-tab="terminal" onclick="switchTab('terminal')">
                        <span>ğŸ’»</span>
                        <span>ç»ˆç«¯</span>
                    </div>
                    <div class="tab" data-tab="files" onclick="switchTab('files')">
                        <span>ğŸ“</span>
                        <span>æ–‡ä»¶</span>
                    </div>
                    <div class="tab" data-tab="monitor" onclick="switchTab('monitor')">
                        <span>ğŸ“Š</span>
                        <span>ç›‘æ§</span>
                    </div>
                    <div class="tab" data-tab="scripts" onclick="switchTab('scripts')">
                        <span>ğŸ“œ</span>
                        <span>è„šæœ¬</span>
                    </div>
                </div>

                <!-- Tab Content -->
                <div class="tab-content">
                    <!-- Terminal Tab -->
                    <div class="tab-pane active" id="tab-terminal">
                        <div class="terminal-container">
                            <div class="terminal-toolbar">
                                <div class="terminal-info">
                                    <span class="terminal-shell">bash</span>
                                    <span style="color: var(--text-muted);">â€¢</span>
                                    <span class="terminal-path" id="terminalPath">/root</span>
                                </div>
                                <div class="terminal-controls">
                                    <button class="terminal-btn" onclick="clearTerminal()">æ¸…ç©º</button>
                                    <button class="terminal-btn" onclick="reconnectTerminal()">é‡è¿</button>
                                </div>
                            </div>
                            <div class="terminal-output" id="terminalOutput"></div>
                            <div class="terminal-input-line">
                                <span class="terminal-prompt" id="terminalPrompt">#</span>
                                <input type="text" class="terminal-input" id="terminalInput" 
                                       placeholder="è¾“å…¥å‘½ä»¤..." onkeydown="handleTerminalInput(event)">
                            </div>
                        </div>
                    </div>

                    <!-- Files Tab -->
                    <div class="tab-pane" id="tab-files">
                        <div class="files-layout">
                            <!-- Left: File Tree (VSCode Style) -->
                            <div class="file-sidebar">
                                <div class="file-sidebar-header">
                                    <span>èµ„æºç®¡ç†å™¨</span>
                                    <div class="file-sidebar-actions">
                                        <button class="btn btn-icon" onclick="uploadFile()" title="ä¸Šä¼ æ–‡ä»¶">ğŸ“¤</button>
                                        <button class="btn btn-icon" onclick="downloadSelectedFiles()" title="ä¸‹è½½é€‰ä¸­">â¬‡ï¸</button>
                                        <button class="btn btn-icon" onclick="collapseAllFolders()" title="å…¨éƒ¨æŠ˜å ">ğŸ“</button>
                                        <button class="btn btn-icon" onclick="refreshFileTree()" title="åˆ·æ–°">ğŸ”„</button>
                                    </div>
                                </div>
                                <div class="file-tree" id="fileTree">
                                    <div class="file-tree-root" id="fileTreeRoot">
                                        <!-- Dynamic tree will be rendered here -->
                                    </div>
                                </div>
                                <div class="file-selection-info" id="fileSelectionInfo" style="display: none;">
                                    <span id="selectionCount">0</span> é¡¹å·²é€‰ä¸­
                                </div>
                            </div>
                            <!-- Right: File Preview -->
                            <div class="file-preview-panel" id="filePreviewPanel">
                                <div class="file-preview-placeholder" id="filePreviewPlaceholder">
                                    <div style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;">ğŸ“„</div>
                                    <div style="color: var(--text-muted);">é€‰æ‹©æ–‡ä»¶é¢„è§ˆå†…å®¹</div>
                                    <div style="color: var(--text-muted); font-size: 12px; margin-top: 8px;">
                                        æç¤ºï¼šCtrl+ç‚¹å‡»å¤šé€‰ï¼ŒShift+ç‚¹å‡»èŒƒå›´é€‰æ‹©
                                    </div>
                                </div>
                                <div class="file-preview" id="filePreview" style="display: none;">
                                    <div class="file-preview-header">
                                        <div class="file-preview-title">
                                            <span id="previewFilename">æ–‡ä»¶å</span>
                                            <span class="file-preview-size" id="previewFilesize">--</span>
                                        </div>
                                        <div class="file-preview-actions">
                                            <button class="btn btn-sm" onclick="downloadSelectedFile()">â¬‡ï¸ ä¸‹è½½</button>
                                            <button class="btn btn-sm" onclick="closePreview()">âœ•</button>
                                        </div>
                                    </div>
                                    <div class="file-preview-content" id="previewContent">
                                        <!-- File content will be displayed here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Monitor Tab -->
                    <div class="tab-pane" id="tab-monitor">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 12px 16px; background: var(--bg-secondary); border-radius: var(--radius-lg); border: 1px solid var(--border-color);">
                            <div style="font-size: 14px; font-weight: 600;">ğŸ“Š ç³»ç»Ÿç›‘æ§</div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-sm" id="autoRefreshBtn" onclick="toggleMonitorAutoRefresh()">â¸ï¸ æš‚åœåˆ·æ–°</button>
                                <button class="btn btn-sm" onclick="refreshSystemStatus()">ğŸ”„ ç«‹å³åˆ·æ–°</button>
                            </div>
                        </div>
                        <div class="metrics-grid">
                            <!-- CPU -->
                            <div class="metric-card">
                                <div class="metric-header">
                                    <div class="metric-title">ğŸ“Š CPU ä½¿ç”¨ç‡</div>
                                </div>
                                <div class="metric-value" id="metricCpu">--%</div>
                                <div class="metric-subtitle" id="metricCpuDetail">-- æ ¸å¿ƒ</div>
                                <div class="metric-bar">
                                    <div class="metric-bar-fill" id="metricCpuBar" style="width: 0%"></div>
                                </div>
                                <div class="metric-details">
                                    <div class="metric-detail">
                                        <span class="metric-detail-label">ç”¨æˆ·æ€</span>
                                        <span class="metric-detail-value" id="metricCpuUser">--%</span>
                                    </div>
                                    <div class="metric-detail">
                                        <span class="metric-detail-label">ç³»ç»Ÿæ€</span>
                                        <span class="metric-detail-value" id="metricCpuSys">--%</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Memory -->
                            <div class="metric-card">
                                <div class="metric-header">
                                    <div class="metric-title">ğŸ’¾ å†…å­˜ä½¿ç”¨</div>
                                </div>
                                <div class="metric-value" id="metricMem">--</div>
                                <div class="metric-subtitle" id="metricMemDetail">å…± --</div>
                                <div class="metric-bar">
                                    <div class="metric-bar-fill" id="metricMemBar" style="width: 0%"></div>
                                </div>
                                <div class="metric-details">
                                    <div class="metric-detail">
                                        <span class="metric-detail-label">å·²ç”¨</span>
                                        <span class="metric-detail-value" id="metricMemUsed">--</span>
                                    </div>
                                    <div class="metric-detail">
                                        <span class="metric-detail-label">å¯ç”¨</span>
                                        <span class="metric-detail-value" id="metricMemFree">--</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Disk -->
                            <div class="metric-card">
                                <div class="metric-header">
                                    <div class="metric-title">ğŸ’¿ ç£ç›˜ä½¿ç”¨</div>
                                </div>
                                <div class="metric-value" id="metricDisk">--%</div>
                                <div class="metric-subtitle" id="metricDiskDetail">-- / --</div>
                                <div class="metric-bar">
                                    <div class="metric-bar-fill" id="metricDiskBar" style="width: 0%"></div>
                                </div>
                                <div class="metric-details">
                                    <div class="metric-detail">
                                        <span class="metric-detail-label">å·²ç”¨</span>
                                        <span class="metric-detail-value" id="metricDiskUsed">--</span>
                                    </div>
                                    <div class="metric-detail">
                                        <span class="metric-detail-label">å¯ç”¨</span>
                                        <span class="metric-detail-value" id="metricDiskFree">--</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Load & Network -->
                            <div class="metric-card">
                                <div class="metric-header">
                                    <div class="metric-title">âš¡ ç³»ç»Ÿè´Ÿè½½</div>
                                </div>
                                <div class="metric-value" id="metricLoad">--</div>
                                <div class="metric-subtitle">1åˆ†é’Ÿ / 5åˆ†é’Ÿ / 15åˆ†é’Ÿ</div>
                                <div class="metric-details">
                                    <div class="metric-detail">
                                        <span class="metric-detail-label">1m</span>
                                        <span class="metric-detail-value" id="metricLoad1">--</span>
                                    </div>
                                    <div class="metric-detail">
                                        <span class="metric-detail-label">5m</span>
                                        <span class="metric-detail-value" id="metricLoad5">--</span>
                                    </div>
                                    <div class="metric-detail">
                                        <span class="metric-detail-label">15m</span>
                                        <span class="metric-detail-value" id="metricLoad15">--</span>
                                    </div>
                                    <div class="metric-detail">
                                        <span class="metric-detail-label">è¿è¡Œæ—¶é—´</span>
                                        <span class="metric-detail-value" id="metricUptime">--</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Network -->
                            <div class="metric-card large">
                                <div class="metric-header">
                                    <div class="metric-title">ğŸŒ ç½‘ç»œæµé‡</div>
                                </div>
                                <div class="metric-details">
                                    <div class="metric-detail">
                                        <span class="metric-detail-label">IP åœ°å€</span>
                                        <span class="metric-detail-value" id="metricIp">--</span>
                                    </div>
                                    <div class="metric-detail">
                                        <span class="metric-detail-label">MAC åœ°å€</span>
                                        <span class="metric-detail-value" id="metricMac">--</span>
                                    </div>
                                    <div class="metric-detail">
                                        <span class="metric-detail-label">æ¥æ”¶</span>
                                        <span class="metric-detail-value" id="metricRx">--</span>
                                    </div>
                                    <div class="metric-detail">
                                        <span class="metric-detail-label">å‘é€</span>
                                        <span class="metric-detail-value" id="metricTx">--</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Process List -->
                        <div class="process-table" style="margin-top: 24px;">
                            <div class="process-table-header">
                                <span>PID</span>
                                <span>è¿›ç¨‹å</span>
                                <span>CPU</span>
                                <span>å†…å­˜</span>
                                <span>æ—¶é—´</span>
                            </div>
                            <div id="processList">
                                <div style="padding: 40px; text-align: center; color: var(--text-muted);">
                                    æš‚æ— è¿›ç¨‹æ•°æ®
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Scripts Tab -->
                    <div class="tab-pane" id="tab-scripts">
                        <div style="max-width: 900px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <div>
                                    <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 4px;">æ‰§è¡Œè„šæœ¬</h3>
                                    <div style="font-size: 13px; color: var(--text-muted);">åœ¨è®¾å¤‡ä¸Šæ‰§è¡Œ Shell è„šæœ¬</div>
                                </div>
                                <button class="btn btn-primary" onclick="runScript()">â–¶ï¸ è¿è¡Œè„šæœ¬</button>
                            </div>
                            <textarea class="script-editor" id="scriptEditor" placeholder="#!/bin/bash&#10;&#10;# åœ¨æ­¤è¾“å…¥è„šæœ¬ä»£ç &#10;echo 'Hello, World!'&#10;uname -a"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Script Output Modal -->
    <div class="modal-overlay" id="scriptModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">ğŸ“œ è„šæœ¬æ‰§è¡Œç»“æœ</div>
                <button class="modal-close" onclick="closeModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
                    <span id="scriptStatusIcon">â³</span>
                    <span id="scriptStatusText">æ‰§è¡Œä¸­...</span>
                    <span style="margin-left: auto; font-size: 12px; color: var(--text-muted);" id="scriptExitCode"></span>
                </div>
                <pre class="output" id="scriptOutput"></pre>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal()">å…³é—­</button>
                <button class="btn btn-primary" onclick="copyOutput()">ğŸ“‹ å¤åˆ¶è¾“å‡º</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // Configuration
        // ============================================
        const MSG_TYPES = {
            HEARTBEAT: 0x01,
            SYSTEM_STATUS: 0x02,
            LOG_UPLOAD: 0x03,
            SCRIPT_RECV: 0x04,
            SCRIPT_RESULT: 0x05,
            PTY_CREATE: 0x10,
            PTY_DATA: 0x11,
            PTY_RESIZE: 0x12,
            PTY_CLOSE: 0x13,
            FILE_REQUEST: 0x20,
            FILE_DATA: 0x21,
            FILE_LIST_REQUEST: 0x22,
            FILE_LIST_RESPONSE: 0x23,
            DOWNLOAD_PACKAGE: 0x24,
            CMD_REQUEST: 0x30,
            CMD_RESPONSE: 0x31,
            DEVICE_LIST: 0x50
        };

        // ============================================
        // State
        // ============================================
        let ws = null;
        let devices = [];
        let currentDevice = null;
        let currentTab = 'terminal';
        let currentPath = '/root';
        let ptySessionId = null;
        let isConnected = false;

        // ============================================
        // Toast
        // ============================================
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const icons = { success: 'âœ“', error: 'âœ•', warning: 'âš ', info: 'â„¹' };
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span style="font-size: 20px;">${icons[type]}</span>
                <span>${message}</span>
            `;
            
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        // ============================================
        // WebSocket Connection
        // ============================================
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            let wsUrl;
            
            if (window.location.hostname.includes('github.dev')) {
                const wsHostname = window.location.hostname.replace(/-\d+(\.app\.github\.dev)$/, '-8765$1');
                wsUrl = `${protocol}//${wsHostname}/`;
            } else {
                wsUrl = `${protocol}//${window.location.hostname}:8765`;
            }
            
            console.log('Connecting to WebSocket:', wsUrl);
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('WebSocket connected');
                isConnected = true;
                updateConnectionStatus(true);
                showToast('å·²è¿æ¥åˆ°æœåŠ¡å™¨', 'success');
            };

            ws.onclose = () => {
                console.log('WebSocket disconnected');
                isConnected = false;
                updateConnectionStatus(false);
                setTimeout(connectWebSocket, 3000);
            };

            ws.onerror = (err) => {
                console.error('WebSocket error:', err);
            };

            ws.onmessage = async (event) => {
                try {
                    const buffer = await event.data.arrayBuffer();
                    const bytes = new Uint8Array(buffer);
                    const msgType = bytes[0];
                    const data = JSON.parse(new TextDecoder().decode(bytes.slice(1)));
                    console.log('Received message:', msgType, data);
                    handleMessage(msgType, data);
                } catch (err) {
                    console.error('Error handling message:', err);
                }
            };
        }

        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatusText');
            if (connected) {
                statusEl.className = 'connection-status online';
                statusEl.innerHTML = '<span class="connection-dot"></span><span>å·²è¿æ¥</span>';
            } else {
                statusEl.className = 'connection-status';
                statusEl.innerHTML = '<span class="connection-dot"></span><span>æœªè¿æ¥</span>';
            }
        }

        function sendMessage(type, data) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                showToast('æœªè¿æ¥åˆ°æœåŠ¡å™¨', 'error');
                return false;
            }
            
            if (currentDevice && currentDevice.device_id) {
                data.device_id = currentDevice.device_id;
            }
            
            const json = JSON.stringify(data);
            const bytes = new TextEncoder().encode(json);
            const msg = new Uint8Array(1 + bytes.length);
            msg[0] = type;
            msg.set(bytes, 1);
            ws.send(msg);
            console.log('Sent message:', type, data);
            return true;
        }

        // ============================================
        // Message Handler
        // ============================================
        function handleMessage(type, data) {
            switch(type) {
                case MSG_TYPES.DEVICE_LIST:
                    updateDeviceList(data.devices || data);
                    break;
                case MSG_TYPES.SYSTEM_STATUS:
                    updateSystemStatus(data);
                    break;
                case MSG_TYPES.PTY_DATA:
                    handleTerminalData(data);
                    break;
                case MSG_TYPES.FILE_LIST_RESPONSE:
                    // Update both tree and file list
                    if (data.path) {
                        updateTreeWithFiles(data.path, data.files || []);
                    }
                    updateFileList(data.files || []);
                    break;
                case MSG_TYPES.FILE_DATA:
                    handleFileData(data);
                    break;
                case MSG_TYPES.CMD_RESPONSE:
                    handleCommandResponse(data);
                    break;
                case MSG_TYPES.SCRIPT_RESULT:
                    handleScriptResult(data);
                    break;
                default:
                    console.log('Unknown message type:', type, data);
            }
        }

        // ============================================
        // Device Management
        // ============================================
        function updateDeviceList(newDevices) {
            console.log('Updating device list:', newDevices);
            devices = Array.isArray(newDevices) ? newDevices : [];
            renderDeviceList();
        }

        function renderDeviceList() {
            const list = document.getElementById('deviceList');
            const search = document.getElementById('deviceSearch').value.toLowerCase();
            
            const filtered = devices.filter(d => 
                d.device_id.toLowerCase().includes(search)
            );

            if (filtered.length === 0) {
                list.innerHTML = `
                    <div style="padding: 40px; text-align: center; color: var(--text-muted);">
                        <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“¡</div>
                        <div>æš‚æ— è®¾å¤‡</div>
                    </div>
                `;
                return;
            }

            list.innerHTML = filtered.map(device => `
                <div class="device-card ${currentDevice?.device_id === device.device_id ? 'active' : ''}" 
                     onclick="selectDevice('${device.device_id}')">
                    <div class="device-card-header">
                        <div class="device-avatar">ğŸ“±</div>
                        <div class="device-info">
                            <h4>${device.device_id}</h4>
                            <div class="device-status">åœ¨çº¿</div>
                        </div>
                    </div>
                    <div class="device-metrics">
                        <div class="device-metric">
                            <div class="device-metric-value">${device.cpu_usage?.toFixed(0) || '--'}%</div>
                            <div class="device-metric-label">CPU</div>
                        </div>
                        <div class="device-metric">
                            <div class="device-metric-value">${((device.mem_used || 0) / 1024).toFixed(1)}G</div>
                            <div class="device-metric-label">å†…å­˜</div>
                        </div>
                        <div class="device-metric">
                            <div class="device-metric-value">${device.load_1min?.toFixed(1) || '--'}</div>
                            <div class="device-metric-label">è´Ÿè½½</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function filterDevices() {
            renderDeviceList();
        }

        function selectDevice(deviceId) {
            const device = devices.find(d => d.device_id === deviceId);
            if (!device) return;

            // Disconnect from previous device
            if (currentDevice && ptySessionId) {
                sendMessage(MSG_TYPES.PTY_CLOSE, { session_id: ptySessionId });
            }

            currentDevice = device;
            
            // Update UI
            document.querySelectorAll('.device-card').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');

            // Show device detail
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('deviceDetail').classList.add('active');
            document.getElementById('detailDeviceName').textContent = device.device_id;
            document.getElementById('detailDeviceIp').textContent = device.ip_addr || 'IPæœªçŸ¥';

            // Connect terminal
            setTimeout(() => connectTerminal(), 100);
            
            // Refresh files and load file tree
            setTimeout(() => {
                refreshFiles();
                refreshFileTree();
            }, 200);
            
            // Fetch system status immediately
            setTimeout(() => refreshSystemStatus(), 300);
            
            // Start auto-refresh for monitor tab
            startMonitorAutoRefresh();
            
            showToast(`å·²é€‰æ‹©è®¾å¤‡: ${deviceId}`, 'success');
        }

        function disconnectDevice() {
            // Stop monitor auto-refresh
            stopMonitorAutoRefresh();
            
            if (ptySessionId) {
                sendMessage(MSG_TYPES.PTY_CLOSE, { session_id: ptySessionId });
                ptySessionId = null;
            }
            currentDevice = null;
            document.getElementById('deviceDetail').classList.remove('active');
            document.getElementById('emptyState').style.display = 'flex';
            clearTerminal();
        }

        // ============================================
        // Terminal
        // ============================================
        function connectTerminal() {
            if (!currentDevice) return;
            
            ptySessionId = Date.now();
            console.log('Creating PTY session:', ptySessionId);
            
            sendMessage(MSG_TYPES.PTY_CREATE, {
                session_id: ptySessionId,
                rows: 24,
                cols: 80
            });
            
            showToast('æ­£åœ¨è¿æ¥ç»ˆç«¯...', 'info');
        }

        function reconnectTerminal() {
            clearTerminal();
            connectTerminal();
        }

        function handleTerminalData(data) {
            if (data.data) {
                try {
                    const text = atob(data.data);
                    appendTerminalOutput(text);
                } catch (e) {
                    console.error('Error decoding terminal data:', e);
                }
            }
        }

        function handleTerminalInput(e) {
            if (e.key === 'Enter') {
                const input = document.getElementById('terminalInput');
                const cmd = input.value;
                if (!cmd.trim()) return;
                
                input.value = '';
                appendTerminalOutput(`# ${cmd}\n`);
                
                if (ptySessionId) {
                    sendMessage(MSG_TYPES.PTY_DATA, {
                        session_id: ptySessionId,
                        data: btoa(cmd + '\n')
                    });
                }
            }
        }

        function appendTerminalOutput(text) {
            const output = document.getElementById('terminalOutput');
            output.textContent += text;
            output.scrollTop = output.scrollHeight;
        }

        function clearTerminal() {
            document.getElementById('terminalOutput').textContent = '';
        }

        // ============================================
        // Files - VSCode Style Explorer with Multi-Select
        // ============================================
        let fileTreeData = {}; // Cache for tree data
        let selectedFiles = new Set(); // Multi-select support
        let lastSelectedFile = null; // For shift+click range selection
        let expandedDirs = new Set(['/']);
        let allTreeItems = []; // Flat list for range selection

        function refreshFileTree() {
            if (!currentDevice) return;
            console.log('Loading root directory tree...');
            loadTreeItem('/', document.getElementById('fileTreeRoot'));
        }

        function loadTreeItem(path, container) {
            console.log('Loading tree item:', path);
            container.innerHTML = '<div class="tree-loading">åŠ è½½ä¸­...</div>';
            
            sendMessage(MSG_TYPES.FILE_LIST_REQUEST, {
                path: path,
                request_id: 'tree-' + Date.now()
            });
        }

        function renderTreeItem(item, parentPath, index) {
            const fullPath = parentPath === '/' ? '/' + item.name : parentPath + '/' + item.name;
            const isExpanded = expandedDirs.has(fullPath);
            const isDir = item.is_dir;
            
            const div = document.createElement('div');
            const isSelected = selectedFiles.has(fullPath);
            div.className = `tree-item ${isExpanded && isDir ? 'expanded' : ''} ${isSelected ? 'selected' : ''}`;
            div.dataset.path = fullPath;
            div.dataset.isDir = isDir;
            div.dataset.index = index;
            
            // File items don't have toggle, directories do
            const toggleHtml = isDir ? 
                `<span class="tree-toggle">â–¶</span>` : 
                `<span class="tree-toggle empty"></span>`;
            
            const iconHtml = isDir ? 
                (isExpanded ? 'ğŸ“‚' : 'ğŸ“') : 
                getFileIcon(item.name);
            
            div.innerHTML = `
                ${toggleHtml}
                <span class="tree-icon">${iconHtml}</span>
                <span class="tree-label">${item.name}</span>
            `;
            
            // Toggle expand/collapse for directories
            if (isDir) {
                const toggle = div.querySelector('.tree-toggle');
                toggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleTreeItem(fullPath, div);
                });
            }
            
            // Click to select/navigate with multi-select support
            div.addEventListener('click', (e) => {
                handleTreeItemClick(e, fullPath, isDir, item, div);
            });
            
            return div;
        }

        function handleTreeItemClick(e, fullPath, isDir, item, div) {
            // Update focused item
            document.querySelectorAll('.tree-item.focused').forEach(el => el.classList.remove('focused'));
            div.classList.add('focused');
            
            if (isDir) {
                // Directory: navigate and toggle expand
                navigateTo(fullPath);
                const isExpanded = expandedDirs.has(fullPath);
                if (!isExpanded) {
                    toggleTreeItem(fullPath, div);
                }
                // Clear selection when changing directory
                if (!e.ctrlKey && !e.shiftKey) {
                    clearFileSelection();
                }
            } else {
                // File: handle multi-select
                if (e.ctrlKey || e.metaKey) {
                    // Ctrl+Click: toggle selection
                    e.preventDefault();
                    toggleFileSelection(fullPath, div);
                } else if (e.shiftKey && lastSelectedFile) {
                    // Shift+Click: range selection
                    e.preventDefault();
                    selectFileRange(lastSelectedFile, fullPath);
                } else {
                    // Single click: select only this file and preview
                    clearFileSelection();
                    addFileToSelection(fullPath, div);
                    selectFileInTree(fullPath, item);
                }
                lastSelectedFile = fullPath;
            }
            
            updateSelectionInfo();
        }

        function toggleFileSelection(path, element) {
            if (selectedFiles.has(path)) {
                selectedFiles.delete(path);
                element.classList.remove('selected');
            } else {
                selectedFiles.add(path);
                element.classList.add('selected');
            }
        }

        function addFileToSelection(path, element) {
            selectedFiles.add(path);
            element.classList.add('selected');
        }

        function clearFileSelection() {
            selectedFiles.clear();
            document.querySelectorAll('.tree-item.selected').forEach(el => el.classList.remove('selected'));
            lastSelectedFile = null;
        }

        function selectFileRange(startPath, endPath) {
            // Build flat list of all visible items
            const visibleItems = [];
            document.querySelectorAll('.tree-item[data-is-dir="false"]').forEach(el => {
                visibleItems.push({
                    path: el.dataset.path,
                    element: el
                });
            });
            
            const startIndex = visibleItems.findIndex(i => i.path === startPath);
            const endIndex = visibleItems.findIndex(i => i.path === endPath);
            
            if (startIndex === -1 || endIndex === -1) return;
            
            const minIndex = Math.min(startIndex, endIndex);
            const maxIndex = Math.max(startIndex, endIndex);
            
            for (let i = minIndex; i <= maxIndex; i++) {
                const item = visibleItems[i];
                addFileToSelection(item.path, item.element);
            }
        }

        function updateSelectionInfo() {
            const infoEl = document.getElementById('fileSelectionInfo');
            const countEl = document.getElementById('selectionCount');
            
            if (selectedFiles.size > 0) {
                infoEl.style.display = 'block';
                countEl.textContent = selectedFiles.size;
            } else {
                infoEl.style.display = 'none';
            }
        }

        function collapseAllFolders() {
            expandedDirs.clear();
            expandedDirs.add('/'); // Keep root expanded
            
            // Re-render the tree
            document.querySelectorAll('.tree-item.expanded').forEach(el => {
                el.classList.remove('expanded');
                const icon = el.querySelector('.tree-icon');
                if (icon && el.dataset.isDir === 'true') {
                    icon.textContent = 'ğŸ“';
                }
            });
            
            document.querySelectorAll('.tree-children').forEach(el => {
                el.style.display = 'none';
            });
            
            showToast('å·²æŠ˜å æ‰€æœ‰æ–‡ä»¶å¤¹', 'info');
        }

        function downloadSelectedFiles() {
            if (selectedFiles.size === 0) {
                showToast('è¯·å…ˆé€‰æ‹©è¦ä¸‹è½½çš„æ–‡ä»¶', 'warning');
                return;
            }
            
            const files = Array.from(selectedFiles);
            
            if (files.length === 1) {
                // Single file download
                downloadFile(files[0]);
            } else {
                // Multiple files - create zip or download individually
                showToast(`å‡†å¤‡ä¸‹è½½ ${files.length} ä¸ªæ–‡ä»¶...`, 'info');
                
                // Download files one by one with delay to avoid overwhelming
                files.forEach((file, index) => {
                    setTimeout(() => {
                        downloadFile(file);
                    }, index * 500);
                });
            }
        }

        function toggleTreeItem(path, element) {
            const isExpanded = expandedDirs.has(path);
            
            if (isExpanded) {
                expandedDirs.delete(path);
                element.classList.remove('expanded');
                const childrenContainer = element.nextElementSibling;
                if (childrenContainer) {
                    childrenContainer.style.display = 'none';
                }
            } else {
                expandedDirs.add(path);
                element.classList.add('expanded');
                let childrenContainer = element.nextElementSibling;
                
                if (!childrenContainer || !childrenContainer.classList.contains('tree-children')) {
                    childrenContainer = document.createElement('div');
                    childrenContainer.className = 'tree-children';
                    element.parentNode.insertBefore(childrenContainer, element.nextSibling);
                    loadTreeItem(path, childrenContainer);
                } else {
                    childrenContainer.style.display = 'block';
                }
            }
            
            // Update icon
            const icon = element.querySelector('.tree-icon');
            icon.textContent = isExpanded ? 'ğŸ“' : 'ğŸ“‚';
        }

        function updateTreeWithFiles(path, files) {
            console.log('Updating tree for path:', path, 'with files:', files);
            
            // Find the container for this path
            let container;
            if (path === '/') {
                container = document.getElementById('fileTreeRoot');
            } else {
                const parentItem = document.querySelector(`.tree-item[data-path="${path}"]`);
                if (parentItem) {
                    container = parentItem.nextElementSibling;
                    if (!container || !container.classList.contains('tree-children')) {
                        container = document.createElement('div');
                        container.className = 'tree-children';
                        parentItem.parentNode.insertBefore(container, parentItem.nextSibling);
                    }
                }
            }
            
            if (!container) return;
            
            // Sort: directories first, then by name
            files.sort((a, b) => {
                if (a.is_dir && !b.is_dir) return -1;
                if (!a.is_dir && b.is_dir) return 1;
                return a.name.localeCompare(b.name);
            });
            
            // Show both directories and files in tree
            container.innerHTML = '';
            files.forEach((item, index) => {
                container.appendChild(renderTreeItem(item, path, index));
            });
        }

        function refreshCurrentDir() {
            if (!currentDevice) return;
            refreshFiles(currentPath);
        }

        function refreshFiles(path) {
            if (!currentDevice) return;
            console.log('Refreshing files for path:', path);
            sendMessage(MSG_TYPES.FILE_LIST_REQUEST, {
                path: path,
                request_id: 'files-' + Date.now()
            });
        }

        function updateFileList(files) {
            console.log('Updating file list:', files);
            const list = document.getElementById('fileList');
            
            if (!files || files.length === 0) {
                list.innerHTML = `
                    <div class="empty-folder">
                        <div class="empty-folder-icon">ğŸ“‚</div>
                        <div>ç©ºç›®å½•</div>
                    </div>
                `;
                return;
            }

            // Sort: directories first, then files
            files.sort((a, b) => {
                if (a.is_dir && !b.is_dir) return -1;
                if (!a.is_dir && b.is_dir) return 1;
                return a.name.localeCompare(b.name);
            });

            list.innerHTML = files.map(f => `
                <div class="file-item ${selectedFile === f.path ? 'selected' : ''}" 
                     ondblclick="${f.is_dir ? `navigateTo('${f.path}')` : `previewFile('${f.path}', '${f.name}', ${f.size})`}"
                     onclick="selectFileItem('${f.path}', ${f.is_dir}, '${f.name}', ${f.size})">
                    <span class="file-icon">${f.is_dir ? 'ğŸ“' : getFileIcon(f.name)}</span>
                    <div class="file-details">
                        <div class="file-name">${f.name}</div>
                        <div class="file-meta">${f.is_dir ? 'ç›®å½•' : formatDate(f.modified)}</div>
                    </div>
                    <div class="file-size">${f.is_dir ? '--' : formatBytes(f.size)}</div>
                </div>
            `).join('');
        }

        function selectFileItem(path, isDir, name, size) {
            // Remove previous selection
            document.querySelectorAll('.file-item.selected').forEach(el => el.classList.remove('selected'));
            
            // Add selection to clicked item
            event.currentTarget.classList.add('selected');
            selectedFile = path;
            
            if (!isDir) {
                previewFile(path, name, size);
            }
        }

        function selectFileInTree(path, item) {
            previewFile(path, item.name, item.size);
        }

        // Pending file preview requests
        let pendingFilePreview = null;

        function previewFile(path, name, size) {
            console.log('Previewing file:', path, name, size);
            
            const preview = document.getElementById('filePreview');
            const placeholder = document.getElementById('filePreviewPlaceholder');
            const previewName = document.getElementById('previewFilename');
            const previewSize = document.getElementById('previewFilesize');
            const previewContent = document.getElementById('previewContent');
            
            placeholder.style.display = 'none';
            preview.style.display = 'flex';
            previewName.textContent = name;
            previewSize.textContent = formatBytes(size);
            
            // Check file type
            const ext = name.split('.').pop().toLowerCase();
            const imageExts = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'];
            const textExts = ['txt', 'log', 'md', 'json', 'xml', 'html', 'css', 'js', 'py', 'sh', 'conf', 'cfg', 'ini', 'yaml', 'yml', 'toml', 'ini', 'properties'];
            const codeExts = ['c', 'cpp', 'h', 'hpp', 'java', 'go', 'rs', 'rb', 'php', 'pl', 'lua', 'swift', 'kt'];
            
            previewContent.className = 'file-preview-content';
            previewContent.innerHTML = '<div style="color: var(--text-muted); text-align: center; padding: 40px;">åŠ è½½ä¸­...</div>';
            
            if (imageExts.includes(ext)) {
                // For images, try to display via download URL
                previewContent.classList.add('image');
                previewContent.innerHTML = '<div style="color: var(--text-muted);">å›¾ç‰‡é¢„è§ˆåŠŸèƒ½å¼€å‘ä¸­</div>';
            } else if (textExts.includes(ext) || codeExts.includes(ext) || size < 51200) { // Text/code files or files < 50KB
                // Request file content from server
                previewContent.innerHTML = '<div style="color: var(--text-muted); text-align: center; padding: 40px;">æ­£åœ¨åŠ è½½æ–‡ä»¶å†…å®¹...</div>';
                
                pendingFilePreview = { path, name, ext };
                
                // Send file read request
                sendMessage(MSG_TYPES.FILE_REQUEST, {
                    action: 'read',
                    filepath: path,
                    offset: 0,
                    length: Math.min(size, 102400) // Max 100KB
                });
                
                // Set timeout
                setTimeout(() => {
                    if (pendingFilePreview && pendingFilePreview.path === path) {
                        previewContent.innerHTML = '<div style="color: var(--text-muted);">åŠ è½½è¶…æ—¶ï¼Œè¯·é‡è¯•</div>';
                        pendingFilePreview = null;
                    }
                }, 5000);
            } else {
                // Binary or large file
                previewContent.classList.add('binary');
                previewContent.textContent = `äºŒè¿›åˆ¶æ–‡ä»¶æˆ–æ–‡ä»¶è¿‡å¤§ (${formatBytes(size)})\n\nè¯·ä¸‹è½½åæŸ¥çœ‹`;
            }
        }

        function handleFileData(data) {
            console.log('Received file data:', data);
            
            if (!pendingFilePreview) return;
            
            const { path, name, ext } = pendingFilePreview;
            const previewContent = document.getElementById('previewContent');
            
            if (data.error) {
                previewContent.innerHTML = `<div style="color: var(--accent-error);">é”™è¯¯: ${data.error}</div>`;
                pendingFilePreview = null;
                return;
            }
            
            if (data.content) {
                try {
                    // Decode base64 content
                    const content = atob(data.content);
                    
                    // Apply syntax highlighting for code files
                    const codeExts = ['js', 'py', 'sh', 'json', 'xml', 'html', 'css', 'c', 'cpp', 'h', 'java', 'go', 'rs', 'php', 'rb', 'lua'];
                    if (codeExts.includes(ext)) {
                        previewContent.innerHTML = `<pre style="margin: 0; font-family: 'JetBrains Mono', monospace; font-size: 12px; line-height: 1.5;"><code>${escapeHtml(content)}</code></pre>`;
                    } else {
                        // Plain text
                        previewContent.textContent = content;
                    }
                } catch (e) {
                    console.error('Error decoding file content:', e);
                    previewContent.innerHTML = '<div style="color: var(--text-muted);">æ— æ³•è§£ç æ–‡ä»¶å†…å®¹</div>';
                }
            } else if (data.chunk_data) {
                // Handle chunked data
                try {
                    const content = atob(data.chunk_data);
                    previewContent.textContent = content;
                } catch (e) {
                    previewContent.innerHTML = '<div style="color: var(--text-muted);">æ— æ³•è§£ç æ–‡ä»¶å†…å®¹</div>';
                }
            } else {
                previewContent.innerHTML = '<div style="color: var(--text-muted);">æ–‡ä»¶å†…å®¹ä¸ºç©º</div>';
            }
            
            pendingFilePreview = null;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function closePreview() {
            document.getElementById('filePreview').style.display = 'none';
            document.getElementById('filePreviewPlaceholder').style.display = 'flex';
            // Don't clear selection, just close preview
        }

        function downloadSelectedFile() {
            // Download currently previewed file or first selected file
            const files = Array.from(selectedFiles);
            if (files.length > 0) {
                downloadFile(files[0]);
            } else {
                showToast('è¯·å…ˆé€‰æ‹©æ–‡ä»¶', 'warning');
            }
        }

        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const icons = {
                js: 'ğŸ“œ', py: 'ğŸ', sh: 'âš¡', txt: 'ğŸ“',
                json: 'ğŸ“‹', xml: 'ğŸ“„', html: 'ğŸŒ', css: 'ğŸ¨',
                jpg: 'ğŸ–¼ï¸', jpeg: 'ğŸ–¼ï¸', png: 'ğŸ–¼ï¸', gif: 'ğŸ–¼ï¸', 
                bmp: 'ğŸ–¼ï¸', webp: 'ğŸ–¼ï¸', pdf: 'ğŸ“•',
                zip: 'ğŸ“¦', tar: 'ğŸ“¦', gz: 'ğŸ“¦', rar: 'ğŸ“¦',
                log: 'ğŸ“‹', md: 'ğŸ“', conf: 'âš™ï¸', cfg: 'âš™ï¸',
                ini: 'âš™ï¸', yaml: 'âš™ï¸', yml: 'âš™ï¸'
            };
            return icons[ext] || 'ğŸ“„';
        }

        function navigateTo(path) {
            currentPath = path;
            document.getElementById('terminalPath').textContent = path;
            
            // Clear file selection when navigating
            clearFileSelection();
            updateSelectionInfo();
            
            refreshFiles(path);
            
            // Update tree selection - only highlight directory
            document.querySelectorAll('.tree-item').forEach(el => {
                el.classList.remove('selected');
                if (el.dataset.path === path && el.dataset.isDir === 'true') {
                    el.classList.add('selected');
                }
            });
        }

        function uploadFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    showToast(`å‡†å¤‡ä¸Šä¼ : ${file.name}`, 'info');
                    // TODO: Implement file upload
                }
            };
            input.click();
        }

        function downloadFile(path) {
            sendMessage(MSG_TYPES.DOWNLOAD_PACKAGE, {
                path: path,
                format: 'zip'
            });
            showToast('å¼€å§‹ä¸‹è½½...', 'info');
        }

        // ============================================
        // System Status - Enhanced
        // ============================================
        function updateSystemStatus(data) {
            console.log('Updating system status:', data);
            
            // Update device card
            if (currentDevice && data.device_id === currentDevice.device_id) {
                renderDeviceList();
            }

            // Update IP address if we have it
            if (data.ip_addr && currentDevice) {
                document.getElementById('detailDeviceIp').textContent = data.ip_addr;
                document.getElementById('metricIp').textContent = data.ip_addr;
                currentDevice.ip_addr = data.ip_addr;
            }

            // CPU
            const cpuUsage = data.cpu_usage || 0;
            document.getElementById('metricCpu').textContent = cpuUsage.toFixed(1) + '%';
            document.getElementById('metricCpuDetail').textContent = `${data.cpu_cores || '--'} æ ¸å¿ƒ`;
            document.getElementById('metricCpuBar').style.width = cpuUsage + '%';
            document.getElementById('metricCpuBar').className = 'metric-bar-fill ' + (cpuUsage > 80 ? 'high' : cpuUsage > 50 ? 'medium' : 'low');
            document.getElementById('metricCpuUser').textContent = (data.cpu_user || 0).toFixed(1) + '%';
            document.getElementById('metricCpuSys').textContent = (data.cpu_system || 0).toFixed(1) + '%';

            // Memory
            const memTotal = data.mem_total || 1;
            const memUsed = data.mem_used || 0;
            const memPercent = (memUsed / memTotal) * 100;
            document.getElementById('metricMem').textContent = formatBytes(memUsed * 1024 * 1024);
            document.getElementById('metricMemDetail').textContent = `å…± ${formatBytes(memTotal * 1024 * 1024)}`;
            document.getElementById('metricMemBar').style.width = memPercent + '%';
            document.getElementById('metricMemBar').className = 'metric-bar-fill ' + (memPercent > 80 ? 'high' : memPercent > 50 ? 'medium' : 'low');
            document.getElementById('metricMemUsed').textContent = formatBytes(memUsed * 1024 * 1024);
            document.getElementById('metricMemFree').textContent = formatBytes((memTotal - memUsed) * 1024 * 1024);

            // Disk
            const diskTotal = data.disk_total || 1;
            const diskUsed = data.disk_used || 0;
            const diskPercent = (diskUsed / diskTotal) * 100;
            document.getElementById('metricDisk').textContent = diskPercent.toFixed(1) + '%';
            document.getElementById('metricDiskDetail').textContent = `${formatBytes(diskUsed * 1024 * 1024)} / ${formatBytes(diskTotal * 1024 * 1024)}`;
            document.getElementById('metricDiskBar').style.width = diskPercent + '%';
            document.getElementById('metricDiskBar').className = 'metric-bar-fill ' + (diskPercent > 80 ? 'high' : diskPercent > 50 ? 'medium' : 'low');
            document.getElementById('metricDiskUsed').textContent = formatBytes(diskUsed * 1024 * 1024);
            document.getElementById('metricDiskFree').textContent = formatBytes((diskTotal - diskUsed) * 1024 * 1024);

            // Load & Uptime
            document.getElementById('metricLoad').textContent = (data.load_1min || 0).toFixed(2);
            document.getElementById('metricLoad1').textContent = (data.load_1min || 0).toFixed(2);
            document.getElementById('metricLoad5').textContent = (data.load_5min || 0).toFixed(2);
            document.getElementById('metricLoad15').textContent = (data.load_15min || 0).toFixed(2);
            document.getElementById('metricUptime').textContent = formatUptime(data.uptime || 0);

            // Network
            document.getElementById('metricMac').textContent = data.mac_addr || '--';
            document.getElementById('metricRx').textContent = formatBytes(data.net_rx_bytes || 0);
            document.getElementById('metricTx').textContent = formatBytes(data.net_tx_bytes || 0);

            // Update device card metrics
            if (currentDevice) {
                currentDevice.cpu_usage = data.cpu_usage;
                currentDevice.mem_used = data.mem_used;
                currentDevice.load_1min = data.load_1min;
                renderDeviceList();
            }
            
            // Update process list if available
            if (data.processes && Array.isArray(data.processes)) {
                updateProcessList(data.processes);
            }
        }

        function updateProcessList(processes) {
            const container = document.getElementById('processList');
            if (!processes || processes.length === 0) {
                container.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-muted);">æš‚æ— è¿›ç¨‹æ•°æ®</div>';
                return;
            }
            
            // Sort by CPU usage descending
            const sortedProcesses = [...processes].sort((a, b) => (b.cpu || 0) - (a.cpu || 0)).slice(0, 20);
            
            container.innerHTML = sortedProcesses.map(p => `
                <div class="process-row">
                    <span class="process-pid">${p.pid || '--'}</span>
                    <span class="process-name" title="${p.name || ''}">${p.name || '--'}</span>
                    <span class="process-cpu">${(p.cpu || 0).toFixed(1)}%</span>
                    <span class="process-mem">${formatBytes((p.mem || 0) * 1024)}</span>
                    <span style="color: var(--text-muted);">${p.time || '--'}</span>
                </div>
            `).join('');
        }

        // ============================================
        // Monitor Auto-Refresh
        // ============================================
        let monitorRefreshInterval = null;
        let isMonitorAutoRefreshEnabled = false;
        const MONITOR_REFRESH_INTERVAL = 5000; // 5 seconds - balance between performance and real-time

        function startMonitorAutoRefresh() {
            if (monitorRefreshInterval) {
                clearInterval(monitorRefreshInterval);
            }
            
            isMonitorAutoRefreshEnabled = true;
            
            // Immediate refresh
            if (currentTab === 'monitor') {
                refreshSystemStatus();
            }
            
            // Setup interval
            monitorRefreshInterval = setInterval(() => {
                if (currentTab === 'monitor' && currentDevice && isMonitorAutoRefreshEnabled) {
                    refreshSystemStatus();
                }
            }, MONITOR_REFRESH_INTERVAL);
            
            console.log('Monitor auto-refresh started');
        }

        function stopMonitorAutoRefresh() {
            if (monitorRefreshInterval) {
                clearInterval(monitorRefreshInterval);
                monitorRefreshInterval = null;
            }
            isMonitorAutoRefreshEnabled = false;
            console.log('Monitor auto-refresh stopped');
        }

        function toggleMonitorAutoRefresh() {
            isMonitorAutoRefreshEnabled = !isMonitorAutoRefreshEnabled;
            const btn = document.getElementById('autoRefreshBtn');
            if (btn) {
                btn.textContent = isMonitorAutoRefreshEnabled ? 'â¸ï¸ æš‚åœåˆ·æ–°' : 'â–¶ï¸ è‡ªåŠ¨åˆ·æ–°';
                btn.classList.toggle('btn-primary', isMonitorAutoRefreshEnabled);
            }
            showToast(isMonitorAutoRefreshEnabled ? 'è‡ªåŠ¨åˆ·æ–°å·²å¼€å¯ (5ç§’)' : 'è‡ªåŠ¨åˆ·æ–°å·²æš‚åœ', 'info');
        }

        function refreshSystemStatus() {
            if (!currentDevice) return;
            sendMessage(MSG_TYPES.CMD_REQUEST, {
                cmd: 'status',
                request_id: 'status-' + Date.now()
            });
        }

        function handleCommandResponse(data) {
            if (data.request_id?.startsWith('status')) {
                // System status response
                updateSystemStatus(data);
            } else if (data.output) {
                // Command output
                appendTerminalOutput(data.output + '\n');
            }
        }

        // ============================================
        // Scripts
        // ============================================
        function runScript() {
            if (!currentDevice) {
                showToast('è¯·å…ˆé€‰æ‹©è®¾å¤‡', 'warning');
                return;
            }

            const script = document.getElementById('scriptEditor').value;
            if (!script.trim()) {
                showToast('è¯·è¾“å…¥è„šæœ¬å†…å®¹', 'warning');
                return;
            }

            document.getElementById('scriptModal').classList.add('active');
            document.getElementById('scriptStatusIcon').textContent = 'â³';
            document.getElementById('scriptStatusText').textContent = 'æ‰§è¡Œä¸­...';
            document.getElementById('scriptExitCode').textContent = '';
            document.getElementById('scriptOutput').textContent = 'æ­£åœ¨æ‰§è¡Œè„šæœ¬...';

            sendMessage(0x04, {  // SCRIPT_RECV
                script_id: 'script-' + Date.now(),
                content: script,
                execute: true
            });
        }

        function handleScriptResult(data) {
            const icon = data.success ? 'âœ“' : 'âœ•';
            const text = data.success ? 'æ‰§è¡ŒæˆåŠŸ' : 'æ‰§è¡Œå¤±è´¥';
            const color = data.success ? 'var(--accent-success)' : 'var(--accent-error)';
            
            document.getElementById('scriptStatusIcon').textContent = icon;
            document.getElementById('scriptStatusIcon').style.color = color;
            document.getElementById('scriptStatusText').textContent = text;
            document.getElementById('scriptStatusText').style.color = color;
            document.getElementById('scriptExitCode').textContent = `é€€å‡ºç : ${data.exit_code}`;
            document.getElementById('scriptOutput').textContent = data.output || 'æ— è¾“å‡º';
            
            showToast(`è„šæœ¬æ‰§è¡Œ${data.success ? 'æˆåŠŸ' : 'å¤±è´¥'}`, data.success ? 'success' : 'error');
        }

        function closeModal() {
            document.getElementById('scriptModal').classList.remove('active');
        }

        function copyOutput() {
            const output = document.getElementById('scriptOutput').textContent;
            navigator.clipboard.writeText(output).then(() => {
                showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            });
        }

        // ============================================
        // Navigation
        // ============================================
        function showView(view) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.querySelector(`[data-view="${view}"]`)?.classList.add('active');

            if (view === 'devices') {
                disconnectDevice();
            }
        }

        function switchTab(tab) {
            currentTab = tab;
            
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            document.querySelector(`[data-tab="${tab}"]`)?.classList.add('active');
            
            document.querySelectorAll('.tab-pane').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tab}`)?.classList.add('active');

            if (tab === 'files') {
                refreshFiles();
            } else if (tab === 'monitor') {
                // Immediate refresh when switching to monitor tab
                refreshSystemStatus();
                // Ensure auto-refresh is running
                if (!monitorRefreshInterval && currentDevice) {
                    startMonitorAutoRefresh();
                }
            }
        }

        function rebootDevice() {
            if (!currentDevice) {
                showToast('è¯·å…ˆé€‰æ‹©è®¾å¤‡', 'warning');
                return;
            }
            
            if (confirm('ç¡®å®šè¦é‡å¯è®¾å¤‡å—ï¼Ÿ')) {
                sendMessage(MSG_TYPES.CMD_REQUEST, { cmd: 'reboot' });
                showToast('é‡å¯å‘½ä»¤å·²å‘é€', 'info');
                setTimeout(() => disconnectDevice(), 1000);
            }
        }

        function showSettings() {
            showToast('è®¾ç½®åŠŸèƒ½å¼€å‘ä¸­...', 'info');
        }

        // ============================================
        // Utilities
        // ============================================
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatUptime(seconds) {
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            
            if (days > 0) return `${days}å¤© ${hours}å°æ—¶`;
            if (hours > 0) return `${hours}å°æ—¶ ${minutes}åˆ†é’Ÿ`;
            return `${minutes}åˆ†é’Ÿ`;
        }

        function formatDate(timestamp) {
            if (!timestamp) return '--';
            return new Date(timestamp * 1000).toLocaleString();
        }

        // ============================================
        // Init
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            connectWebSocket();
        });
    </script>
</body>
</html>
